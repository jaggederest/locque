# Either helpers tests

import assert as A
import arithmetic as Ar
import either as E
import logic as L
import prelude as P
import typeclass::equality as Eq

open A exposing assert-eq end
open Eq exposing Equality end
open P exposing Either::left Either::right end

module test::either::basics contains
  define transparent inc as
    function x Natural returns Natural value
      Ar::add x 1
    end

  define transparent left1 as Either::left Natural Natural 1
  define transparent right5 as Either::right Natural Natural 5

  define transparent not-eq-1-2 as
    unpack (L::decide-eq-nat 1 2) as flag proof in
      match flag of-type Boolean as flag returns (L::Not (equal Natural 1 2))
        case Boolean::false as proof
        case Boolean::true as P::error (L::Not (equal Natural 1 2)) "expected false"
      end
    end

  define transparent decidable-left as
    E::to-decidable (equal Natural 1 2)
      (Either::left (L::Not (equal Natural 1 2)) (equal Natural 1 2) not-eq-1-2)

  define transparent decidable-right as
    E::to-decidable (equal Natural 1 1)
      (Either::right (L::Not (equal Natural 1 1)) (equal Natural 1 1) (reflexive Natural 1))

  define transparent map-left-left as
    E::map-left Natural Natural Natural inc left1

  define transparent map-left-right as
    E::map-left Natural Natural Natural inc right5

  define transparent map-right-left as
    E::map-right Natural Natural Natural inc left1

  define transparent map-right-right as
    E::map-right Natural Natural Natural inc right5

  define transparent bind-right-right as
    E::bind-right Natural Natural Natural
      (function x Natural returns (P::Either Natural Natural) value
        Either::right Natural Natural (Ar::add x 3)
      end)
      right5

  define transparent bind-right-left as
    E::bind-right Natural Natural Natural
      (function x Natural returns (P::Either Natural Natural) value
        Either::right Natural Natural (Ar::add x 3)
      end)
      left1

  define transparent swap-left as
    E::swap Natural Natural left1

  define transparent swap-right as
    E::swap Natural Natural right5

  define transparent main as compute
    perform (P::sequence-unit
      [
        (assert-eq Boolean (E::is-left Natural Natural left1) true)
      , (assert-eq Boolean (E::is-right Natural Natural right5) true)
      , (assert-eq Natural (E::fold Natural Natural Natural
                                                    (function x Natural returns Natural value x end)
                                                    (function y Natural returns Natural value y end)
                                                    map-left-left) 2)
      , (assert-eq Natural (E::fold Natural Natural Natural
                                                      (function x Natural returns Natural value x end)
                                                      (function y Natural returns Natural value y end)
                                                      map-left-right) 5)
      , (assert-eq Natural (E::fold Natural Natural Natural
                                                        (function x Natural returns Natural value x end)
                                                        (function y Natural returns Natural value y end)
                                                        map-right-left) 1)
      , (assert-eq Natural (E::fold Natural Natural Natural
                                                          (function x Natural returns Natural value x end)
                                                          (function y Natural returns Natural value y end)
                                                          map-right-right) 6)
      , (assert-eq Natural (E::fold Natural Natural Natural
                                                            (function x Natural returns Natural value x end)
                                                            (function y Natural returns Natural value y end)
                                                            bind-right-right) 8)
      , (assert-eq Natural (E::fold Natural Natural Natural
                                                              (function x Natural returns Natural value x end)
                                                              (function y Natural returns Natural value y end)
                                                              bind-right-left) 1)
      , (assert-eq Natural (E::fold Natural Natural Natural
                                                                  (function x Natural returns Natural value x end)
                                                                  (function y Natural returns Natural value y end)
                                                                  swap-left) 1)
      , (assert-eq Natural (E::fold Natural Natural Natural
                                                                  (function x Natural returns Natural value x end)
                                                                  (function y Natural returns Natural value y end)
                                                                  swap-right) 5)
      , (assert-eq Boolean
          (L::decidable-flag (equal Natural 1 2) decidable-left)
          false)
      , (assert-eq Boolean
          (L::decidable-flag (equal Natural 1 1) decidable-right)
          true)
      ])
  end
end
