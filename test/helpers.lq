# Test helpers for reducing boilerplate in test suites

import assert as A
import io as IO
import list as L
import prelude as P
import string as S
import typeclass::equality as Eq
import type_aliases as Types

open A exposing assert-eq end
open Eq exposing Equality end

module test::helpers contains
  define transparent with-output as
    function A Type0
             action (computation A)
             check (Types::Function (List String) (Types::Function A (computation Unit)))
    returns computation A value
      P::bind-comp (Pair (List String) A) A
        (IO::capture-output A action)
        (function result (Pair (List String) A) returns computation A value
          match result of-type (Pair (List String) A) as ignored returns (computation A)
            case Pair::pair with output (List String) captured A as
              P::map-comp Unit A
                (function ignored Unit returns A value
                  captured
                end)
                (check output captured)
          end
        end)
    end

  define transparent output-string as
    function output (List String) returns String value
      S::join-with "\n" output
    end

  define transparent assert-no-output as
    function A Type0 action (computation A) returns computation A value
      with-output A action
        (function output (List String) ignored A returns computation Unit compute
          perform (assert-eq Natural (P::length-list String output) 0)
        end)
    end

  define transparent assert-single-output as
    function A Type0 expected String action (computation A) returns computation A value
      with-output A action
        (function output (List String) ignored A returns computation Unit compute
          perform (P::sequence-unit
            [
              (assert-eq Natural (P::length-list String output) 1)
            , (assert-eq String (L::nth String 0 output) expected)
            ])
        end)
    end

  define transparent assert-output-contains as
    function A Type0 needle String action (computation A) returns computation A value
      with-output A action
        (function output (List String) ignored A returns computation Unit compute
          perform (assert-eq Boolean (S::has-substring needle (output-string output)) true)
        end)
    end
end
