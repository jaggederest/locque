import prelude as P
import assert as A
import file as File
import string as S
import typeclass::equality as Eq
import typeclass::order as Order

module test::file::stat contains
  define transparent base-dir as "test/tmp/fs_stat"

  define transparent path as
    function suffix String returns String value
      S::concat base-dir suffix
    end

  define transparent setup as compute
    perform (P::sequence-unit
      [
        (File::remove-directory base-dir)
      , (File::make-directory base-dir)
      , (File::write-file (path "/data.txt") "stat")
      , (File::make-directory (path "/dir"))
      ])
  end

  define transparent check-file as
    P::bind-comp (Pair String (Pair Natural Natural)) Unit
      (File::stat (path "/data.txt"))
      (function info (Pair String (Pair Natural Natural)) returns computation Unit value
        P::sequence-unit
          [
            (A::assert-eq String (File::stat-type info) "file")
          , (A::assert-eq Natural (File::stat-size info) 4)
          , (A::assert-eq Boolean (Order::greater-than Natural (File::stat-mtime info) 0) true)
          ]
      end)

  define transparent check-dir as
    P::bind-comp (Pair String (Pair Natural Natural)) Unit
      (File::stat (path "/dir"))
      (function info (Pair String (Pair Natural Natural)) returns computation Unit value
        P::sequence-unit
          [
            (A::assert-eq String (File::stat-type info) "directory")
          , (A::assert-eq Natural (File::stat-size info) 0)
          , (A::assert-eq Boolean (Order::greater-than Natural (File::stat-mtime info) 0) true)
          ]
      end)

  define transparent main as compute
    perform (P::sequence-unit
      [
        setup
      , check-file
      , check-dir
      ])
  end
end
