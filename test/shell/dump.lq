import prelude as P
# Test: Dump output via smyth for type and core views

import shell as S
import string as Str
import assert as A
import typeclass::equality as Eq

open A exposing assert-eq end
open Eq exposing Equality end

module test::shell::dump contains
  define transparent test-dump-bundle as compute
    bind output from perform
      (S::shell "cd /Users/justin/Code/locque && smyth dump --multi lib/prelude.lq types core -- lib/assert.lq types-elaborated:assert-eq")
    then
      perform (P::sequence-unit
        [
          (assert-eq Boolean
            (Str::has-substring "(of-type not (for-all (x Boolean) Boolean))" output)
            true)
        , (assert-eq Boolean
            (Str::has-substring "(define transparent not" output)
            true)
        , (assert-eq Boolean
            (Str::has-substring "__req__Eq_Equality__eq" output)
            true)
        ])
    end
  end

  define transparent test-dump-types-normalized as compute
    bind output from perform
      (S::shell "cd /Users/justin/Code/locque && smyth dump types-normalized lib/prelude.lq map")
    then
      perform (P::sequence-unit
        [
          (assert-eq Boolean
            (Str::has-substring "(for-all (x A) B)" output)
            true)
        , (assert-eq Boolean
            (Str::has-substring "Types::Function" output)
            false)
        ])
    end
  end

  define transparent test-dump-types-normalized-either as compute
    bind output from perform
      (S::shell "cd /Users/justin/Code/locque && smyth dump types-normalized lib/either.lq map-right")
    then
      perform (P::sequence-unit
        [
          (assert-eq Boolean
            (Str::has-substring "(for-all (x B) C)" output)
            true)
        , (assert-eq Boolean
            (Str::has-substring "Types::Function" output)
            false)
        ])
    end
  end

  define transparent main as compute
    perform (P::sequence-unit
      [
        test-dump-bundle
      , test-dump-types-normalized
      , test-dump-types-normalized-either
      ])
  end
end
