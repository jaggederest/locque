# Test: Validate error message fuzzy matching using shell
# This test runs smyth with intentionally broken code and validates the error output

import shell as S
import string as Str
import assert as A
import typeclass::equality as Eq

open A exposing assert-eq end
open Eq exposing Equality end

module test::shell::validate_error_messages contains
  define transparent test-unqualified-fuzzy-match as compute
    bind output from perform
      (S::shell "cd /Users/justin/Code/locque && smyth run test/errors/fuzzy_match_unqualified.lq 2>&1")
    then
      perform
        (assert-eq Boolean
          (Str::string-contains "Did you mean: my-function?" output)
          true)
    end
  end

  define transparent test-qualified-fuzzy-match as compute
    bind output from perform
      (S::shell "cd /Users/justin/Code/locque && smyth run test/errors/fuzzy_match_type.lq 2>&1")
    then
      perform
        (assert-eq Boolean
          (Str::string-contains "Did you mean: P::add-nat?" output)
          true)
    end
  end

  define transparent main as compute
    sequence
      test-unqualified-fuzzy-match
      test-qualified-fuzzy-match
    end
  end
end
