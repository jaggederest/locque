import assert as A
import prelude as P
import shell as Sh
import shell::lhttp as Lhttp
import string as Str

module test::shell::lhttp contains
  define transparent assert-output-missing as
    function needle String output String returns computation Unit value
      A::assert-eq Boolean (Str::has-substring needle output) false
    end

  define transparent test-signal as
    function cmd String returns computation Unit value
      compute
        bind output from perform (Sh::shell cmd) then
          perform (P::sequence-unit
            [
              (assert-output-missing "__still_running__" output)
            , (assert-output-missing "__missing_pid__" output)
            ])
        end
      end
    end

  define transparent sigint-command as
    "cd /Users/justin/Code/locque && pidfile=/tmp/locque_lhttp.pid; rm -f $pidfile; smyth run lib/shell/lhttp.lq --pid-file $pidfile --timeout 10000 -- --port 0 2>&1 & for i in 1 2 3 4 5; do if [ -s \"$pidfile\" ]; then break; fi; sleep 0.2; done; if [ ! -s \"$pidfile\" ]; then echo __missing_pid__; exit 1; fi; pid=$(cat \"$pidfile\"); kill -INT $pid; for i in 1 2 3 4 5; do if ! kill -0 $pid 2>/dev/null; then break; fi; sleep 0.2; done; if kill -0 $pid 2>/dev/null; then echo __still_running__; kill -KILL $pid; sleep 0.1; fi"

  define transparent sigterm-command as
    "cd /Users/justin/Code/locque && pidfile=/tmp/locque_lhttp.pid; rm -f $pidfile; smyth run lib/shell/lhttp.lq --pid-file $pidfile --timeout 10000 -- --port 0 2>&1 & for i in 1 2 3 4 5; do if [ -s \"$pidfile\" ]; then break; fi; sleep 0.2; done; if [ ! -s \"$pidfile\" ]; then echo __missing_pid__; exit 1; fi; pid=$(cat \"$pidfile\"); kill -TERM $pid; for i in 1 2 3 4 5; do if ! kill -0 $pid 2>/dev/null; then break; fi; sleep 0.2; done; if kill -0 $pid 2>/dev/null; then echo __still_running__; kill -KILL $pid; sleep 0.1; fi"

  define transparent main as compute
    perform (P::sequence-unit
      [
        (A::assert-eq Natural Lhttp::default-port 3000)
      , (A::assert-eq Natural
          (Lhttp::port-from-args ["--port", "4001"])
          4001)
      , (A::assert-eq Natural
          (Lhttp::port-from-args (of-type [] (List String)))
          3000)
      , (test-signal sigint-command)
      , (test-signal sigterm-command)
      ])
  end
end
