# Test typeclass method resolution with variable arguments (not just literals)
# This tests that ETyped wrappers propagate type info through DictPass
import assert as A
import typeclass::equality as Eq
import string as S

module test::typecheck::typeclass_variable contains
  # Define a simple typeclass
  define transparent Show as typeclass A of-kind Type0 where
    show of-type (for-all x as A to String)
  end

  # Define instances
  define transparent Show-Natural as instance Show Natural where
    show as function x Natural returns String value
      "natural"
    end
  end

  define transparent Show-Boolean as instance Show Boolean where
    show as function y Boolean returns String value
      "boolean"
    end
  end

  define transparent show-value as
    function A Type0 x A requires Show A returns String value
      show x
    end

  # Test: using show with a variable (not a literal)
  define transparent show-var as
    function x Natural returns String value
      show-value Natural x
    end

  # Test: using show in a higher-order function
  define transparent apply-show as
    function f (for-all x as Natural to String) returns (for-all y as Natural to String) value
      function x Natural returns String value
        f x
      end
    end

  # Test: nested function with typeclass method on variable
  define transparent show-nat-var as
    function x Natural returns String value
      show-value Natural x
    end

  define transparent show-bool-var as
    function y Boolean returns String value
      show-value Boolean y
    end

  define transparent main as compute
    sequence
      (A::assert-eq String (show-var 42) "natural")
      (A::assert-eq String (apply-show show-var 99) "natural")
      (A::assert-eq String (show-nat-var 1) "natural")
      (A::assert-eq String (show-bool-var true) "boolean")
    end
  end
end
